{% extends "layouts/base.html" %}
{% block stylesheets %}
<style>
    /* Page-specific override to reduce vertical spacing in the filter panel */
    .segmentation-filters .settings-section {
        margin-bottom: 24px !important; /* Reduce the large bottom margin */
        padding: 20px; /* Slightly reduce padding */
    }
    .segmentation-filters .section-header {
        margin-bottom: 20px; /* Reduce space below the section title */
        padding-bottom: 15px;
    }
</style>
{% endblock stylesheets %}
{% block title %} Student Segmentation Hub {% endblock %}

{% block content %}

<div class="content">
    <!-- Page Header using your new Hero style -->
    <div class="reports-hero">
        <h2><i class="tim-icons icon-zoom-split"></i> Student Segmentation Hub</h2>
        <p>Create dynamic student segments and perform targeted actions.</p>
    </div>

    <div class="row">
        <!-- Column 1: The Filter Panel -->
         <!-- In segmentation.html, replace the contents of the first col-lg-4 -->

<div class="col-lg-3">

    <div class="settings-card segmentation-filters">
        <div class="settings-tab-content">
            <div class="section-header">
                <h5><i class="tim-icons icon-settings-gear-63"></i> Build Your Segment</h5>
            </div>

            <!-- Location Filters Section -->
            <div class="settings-section">
                <div class="section-header">
                    <h6><i class="tim-icons icon-square-pin"></i> Location</h6>
                </div>
                <div class="form-group-enhanced">
                    <label for="country-filter">Country</label>
                    <select id="country-filter" class="form-control-enhanced" style="width: 100%;">
                        <option value="">-- All Countries --</option>
                        {% for country in countries %}
                            <option value="{{ country.id }}">{{ country.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group-enhanced">
                    <label for="university-filter">University</label>
                    <select id="university-filter" class="form-control-enhanced" style="width: 100%;" disabled>
                        <option value="">-- All Universities --</option>
                    </select>
                </div>
                <div class="form-group-enhanced">
                    <label for="college-filter">College</label>
                    <select id="college-filter" class="form-control-enhanced" style="width: 100%;" disabled>
                        <option value="">-- All Colleges --</option>
                    </select>
                </div>
            </div>

                        <!-- Academic Filters Section -->
            <div class="settings-section">
                <div class="section-header">
                    <h6><i class="tim-icons icon-hat-3"></i> Academics</h6>
                </div>
                <!-- The Year dropdown is now dynamic -->
                <div class="form-group-enhanced">
                    <label for="year-filter">Year</label>
                    <select id="year-filter" class="form-control-enhanced" style="width: 100%;" disabled>
                        <option value="">-- Select College First --</option>
                    </select>
                </div>
                <!-- New Term/Module dropdowns -->
                <div id="term-filter-wrapper" style="display: none;">
                    <div class="form-group-enhanced">
                        <label for="term-filter">Term</label>
                        <select id="term-filter" class="form-control-enhanced" style="width: 100%;"></select>
                    </div>
                </div>
                <div id="module-filter-wrapper" style="display: none;">
                    <div class="form-group-enhanced">
                        <label for="module-filter">Module</label>
                        <select id="module-filter" class="form-control-enhanced" style="width: 100%;"></select>
                    </div>
                </div>
                <!-- The Subject dropdown is now dynamic -->
                <div class="form-group-enhanced">
                    <label for="subject-filter">Subject</label>
                    <select id="subject-filter" class="form-control-enhanced" style="width: 100%;" disabled>
                        <option value="">-- Select Filters Above --</option>
                    </select>
                </div>
                <div class="form-group-enhanced">
                    <label for="instructor-filter">Instructor</label>
                    <select id="instructor-filter" class="form-control-enhanced" style="width: 100%;">
                        <option value="">-- All Instructors --</option>
                         {% for instructor in instructors %}
                            <option value="{{ instructor.id }}">{{ instructor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>


            <!-- Payment Filters Section -->
            <div class="settings-section">
                <div class="section-header">
                    <h6><i class="tim-icons icon-credit-card"></i> Payment</h6>
                </div>
                <div class="form-group-enhanced">
                    <label for="payment-filter">Status</label>
                    <select id="payment-filter" class="form-control-enhanced" style="width: 100%;">
                        <option value="">-- Any Status --</option>
                        <option value="has_paid">Has Made a Payment</option>
                        <option value="no_payment">Has No Payments</option>
                    </select>
                </div>
            </div>
            
            <button id="apply-filters-btn" class="btn-report-primary btn-block mt-4">
                <i class="tim-icons icon-single-02"></i> Find Students
            </button>
        </div>
    </div>
</div>


        <!-- Column 2: The Results Panel -->
        <div class="col-lg-9">

            <div class="settings-card">
                <div class="settings-tab-content">
                    <!-- This will be shown initially -->
                    <div id="results-placeholder" class="enhanced-empty-state">
                        <div class="empty-icon"><i class="tim-icons icon-align-left-2"></i></div>
                        <h4>No Segment Built</h4>
                        <p>Use the filters on the left to build a student segment and see the results here.</p>
                    </div>

                    <!-- This will be shown when results are loaded -->
                    <div id="results-container" style="display: none;">
                        <!-- Header with count and action buttons -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 id="results-count" class="m-0"></h5>
                            <div class="header-actions">
                                <button class="btn-export"><i class="tim-icons icon-cloud-download-93"></i> Export CSV</button>
                                <button class="btn-export"><i class="tim-icons icon-mobile"></i> Copy Numbers</button>
                            </div>
                        </div>
                        <!-- Results Table -->
                        <div class="table-responsive">
                            <table class="settings-table" id="results-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>College</th>
                                        <th>Year</th>
                                        <th>WhatsApp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Student rows will be injected here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Initialize all dropdowns
    $('#country-filter, #university-filter, #college-filter, #year-filter, #subject-filter, #instructor-filter, #payment-filter, #term-filter, #module-filter').select2({
        theme: 'bootstrap4',
        width: '100%'
    });

    const countrySelect = $('#country-filter');
    const universitySelect = $('#university-filter');
    const collegeSelect = $('#college-filter');
    const yearSelect = $('#year-filter');
    const termWrapper = $('#term-filter-wrapper');
    const moduleWrapper = $('#module-filter-wrapper');
    const termSelect = $('#term-filter');
    const moduleSelect = $('#module-filter');
    const subjectSelect = $('#subject-filter');

    // --- URL DEFINITIONS ---
    // Using hardcoded paths for reliability in JavaScript
    const urls = {
        getUniversities: '/get-universities-by-country/', // Note the trailing slash
        getColleges: '/get-colleges-by-university/',
        getCollegeYears: '/get-college-years/',
        getCollegeStructure: '/get-college-structure/',
        getTerms: '/get-terms/',
        getModules: '/get-modules/',
        getSubjects: `{{ url_for('main.get_subjects') }}`,
        segmentStudents: `{{ url_for('main.segment_students') }}`,
        customerProfile: `{{ url_for('main.customer_profile', customer_id=0) }}`,
        exportSegment: `{{ url_for('main.export_segment_csv') }}`
    };

    countrySelect.on('change', function() {
        const countryId = $(this).val();
        universitySelect.val(null).trigger('change').prop('disabled', true);
        if (countryId) {
            $.getJSON(urls.getUniversities + countryId, function(data) {
                universitySelect.empty().append('<option value="">-- All Universities --</option>');
                $.each(data.universities, function(key, entry) {
                    universitySelect.append($('<option></option>').attr('value', entry.id).text(entry.name));
                });
                universitySelect.prop('disabled', false);
            });
        }
    });

    universitySelect.on('change', function() {
        const universityId = $(this).val();
        collegeSelect.val(null).trigger('change').prop('disabled', true);
        if (universityId) {
            $.getJSON(urls.getColleges + universityId, function(data) {
                collegeSelect.empty().append('<option value="">-- All Colleges --</option>');
                $.each(data.colleges, function(key, entry) {
                    collegeSelect.append($('<option></option>').attr('value', entry.id).text(entry.name));
                });
                collegeSelect.prop('disabled', false);
            });
        }
    });

    collegeSelect.on('change', function() {
        const collegeId = $(this).val();
        yearSelect.val(null).trigger('change').prop('disabled', true);
        termWrapper.hide();
        moduleWrapper.hide();
        subjectSelect.val(null).trigger('change').prop('disabled', true);

        if (collegeId) {
            $.getJSON(urls.getCollegeYears + collegeId, function(data) {
                yearSelect.empty().append('<option value="">-- All Years --</option>');
                $.each(data.years, function(key, entry) {
                    yearSelect.append($('<option></option>').attr('value', entry.year_number).text(`Year ${entry.year_number}`));
                });
                yearSelect.prop('disabled', false);
            });
        }
    });

    function updateAcademicFilters() {
        const collegeId = collegeSelect.val();
        const year = yearSelect.val();
        termWrapper.hide();
        moduleWrapper.hide();
        subjectSelect.val(null).trigger('change').prop('disabled', true);

        if (collegeId && year) {
            $.getJSON(urls.getCollegeStructure + collegeId, function(data) {
                if (data.structure_type === 'term') {
                    $.getJSON(`${urls.getTerms}${collegeId}/${year}`, function(termData) {
                        termSelect.empty().append('<option value="">-- All Terms --</option>');
                        $.each(termData.terms, function(key, entry) {
                            termSelect.append($('<option></option>').attr('value', entry.id).text(entry.name));
                        });
                        termWrapper.show();
                    });
                } else if (data.structure_type === 'module') {
                    $.getJSON(`${urls.getModules}${collegeId}/${year}`, function(moduleData) {
                        moduleSelect.empty().append('<option value="">-- All Modules --</option>');
                        $.each(moduleData.modules, function(key, entry) {
                            moduleSelect.append($('<option></option>').attr('value', entry.id).text(entry.name));
                        });
                        moduleWrapper.show();
                    });
                }
            });
        }
        updateSubjectFilter();
    }

    function updateSubjectFilter() {
        const collegeId = collegeSelect.val();
        const year = yearSelect.val();
        const termId = termSelect.val();
        const moduleId = moduleSelect.val();
        subjectSelect.val(null).trigger('change').prop('disabled', true);

        if (collegeId && year) {
            let params = new URLSearchParams({ college_id: collegeId, year: year });
            if (termId) params.append('term_id', termId);
            if (moduleId) params.append('module_id', moduleId);
            
            $.getJSON(`${urls.getSubjects}?${params.toString()}`, function(data) {
                subjectSelect.empty().append('<option value="">-- All Subjects --</option>');
                $.each(data.subjects, function(key, entry) {
                    subjectSelect.append($('<option></option>').attr('value', entry.id).text(entry.name));
                });
                subjectSelect.prop('disabled', false);
            });
        }
    }

    yearSelect.on('change', updateAcademicFilters);
    termSelect.on('change', updateSubjectFilter);
    moduleSelect.on('change', updateSubjectFilter);

    let lastFilters = {};

    $('#apply-filters-btn').on('click', function() {
        const button = $(this);
        const originalButtonText = button.html();
        button.html('<i class="tim-icons icon-refresh-01 spin"></i> Searching...').prop('disabled', true);

        const filters = {
            country_id: countrySelect.val(),
            university_id: universitySelect.val(),
            college_id: collegeSelect.val(),
            year: yearSelect.val(),
            term_id: termSelect.val(),
            module_id: moduleSelect.val(),
            subject_id: subjectSelect.val(),
            instructor_id: $('#instructor-filter').val(),
            payment_status: $('#payment-filter').val()
        };

        $.ajax({
            url: urls.segmentStudents,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(filters),
            success: function(response) {
                lastFilters = filters;
                const students = response.students;
                const resultsContainer = $('#results-container');
                const resultsPlaceholder = $('#results-placeholder');
                const tableBody = $('#results-table tbody');
                tableBody.empty();
                $('#results-count').text(`Found ${students.length} students`);

                if (students.length > 0) {
                    $.each(students, function(index, student) {
                        const profileUrl = urls.customerProfile.replace('0', student.id);
                        const row = `
                            <tr>
                                <td><a href="${profileUrl}">${student.full_name}</a></td>
                                <td>${student.college_name}</td>
                                <td>${student.year}</td>
                                <td>${student.whatsapp_number}</td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });
                    resultsPlaceholder.hide();
                    resultsContainer.show();
                } else {
                    resultsContainer.hide();
                    resultsPlaceholder.find('h4').text('No Students Found');
                    resultsPlaceholder.find('p').text('Try adjusting your filters to find a matching segment.');
                    resultsPlaceholder.show();
                }
            },
            error: function() {
                alert('An error occurred while fetching the data. Please try again.');
            },
            complete: function() {
                button.html(originalButtonText).prop('disabled', false);
            }
        });
    });

    $('#results-container').on('click', '.btn-export', function() {
        const params = new URLSearchParams();
        for (const key in lastFilters) {
            if (lastFilters[key]) {
                params.append(key, lastFilters[key]);
            }
        }
        const exportUrl = `${urls.exportSegment}?${params.toString()}`;
        window.location.href = exportUrl;
    });
});
</script>
{% endblock javascripts %}
