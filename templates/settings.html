{% extends "layouts/base.html" %}

{% block title %} Settings {% endblock %}

{% block stylesheets %}
{{ super() }}
<style>
    /* This style ensures the forms have vertical spacing */
    .settings-section .form-group-enhanced {
        margin-bottom: 1rem;
    }
    /* Custom styling for our new checkboxes */
    .structure-options {
        display: flex;
        gap: 1.5rem;
        padding-top: 25px; /* Aligns with the button */
    }
    .custom-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .custom-checkbox input {
        margin-right: 0.5rem;
        width: 18px;
        height: 18px;
    }
</style>

{% endblock stylesheets %}


{% block content %}
<div class="content">

    <!-- Settings Header -->
    <div class="settings-header">
        <div class="settings-title">
            <div class="title-icon">
                <i class="tim-icons icon-settings-gear-63"></i>
            </div>
            <div>
                <h2>Application Settings</h2>
                <p>Manage all application data from one central dashboard</p>
            </div>
        </div>
    </div>

    <div class="card settings-card">
        <div class="card-body">
                       <!-- CORRECTED Tab Navigation -->
            <ul class="nav settings-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'academic' %}active{% endif %}" data-toggle="tab" href="#academic" role="tab">
                        <div class="tab-icon"><i class="tim-icons icon-bank"></i></div>
                        <span>Academic</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'financial' %}active{% endif %}" data-toggle="tab" href="#financial" role="tab">
                        <div class="tab-icon"><i class="tim-icons icon-money-coins"></i></div>
                        <span>Financial</span>
                    </a>
                </li>
                
                <!-- === ADD THIS NEW TAB === -->
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'structure' %}active{% endif %}" data-toggle="tab" href="#structure" role="tab">
                        <div class="tab-icon"><i class="tim-icons icon-vector"></i></div>
                        <span>Structure</span>
                    </a>
                </li>
                <!-- ========================= -->

                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'instructors' %}active{% endif %}" data-toggle="tab" href="#instructors" role="tab">
                        <div class="tab-icon"><i class="tim-icons icon-badge"></i></div>
                        <span>Instructors</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'import' %}active{% endif %}" data-toggle="tab" href="#import" role="tab">
                        <div class="tab-icon"><i class="tim-icons icon-cloud-upload-94"></i></div>
                        <span>Data Import</span>
                    </a>
                </li>
            </ul>


            <!-- CORRECTED Tab Content -->
            <div class="tab-content settings-tab-content">
                
                <!-- Academic Tab -->
                <div class="tab-pane fade {% if active_tab == 'academic' %}show active{% endif %}" id="academic">
                    <!-- Add Country -->
                    <div class="settings-section">
                        <div class="section-header"><h5><i class="tim-icons icon-world"></i> Add Country</h5></div>
                        <form action="{{ url_for('add_country') }}" method="post" class="settings-form">
                            <div class="row align-items-end">
                                <div class="col-12 col-lg-8">
                                    <div class="form-group-enhanced">
                                        <label>Country Name</label>
                                        <input type="text" name="country_name" class="form-control-enhanced" placeholder="e.g., Egypt" required>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="form-group-enhanced">
                                        <button type="submit" class="btn btn-settings-primary w-100">
                                            <i class="tim-icons icon-simple-add"></i> Add Country
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Add University -->
                    <div class="settings-section">
                        <div class="section-header"><h5><i class="tim-icons icon-bank"></i> Add University</h5></div>
                        <form action="{{ url_for('add_university') }}" method="post" class="settings-form">
                            <div class="row align-items-end">
                                <div class="col-12 col-lg-4">
                                    <div class="form-group-enhanced">
                                        <label>Select Country</label>
                                        <select name="country_id" class="form-control-enhanced select2-dropdown" required>
                                            <option value="">-- Select --</option>
                                            {% for country in countries %}<option value="{{ country.id }}">{{ country.name }}</option>{% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-5">
                                    <div class="form-group-enhanced">
                                        <label>University Name</label>
                                        <input type="text" name="university_name" class="form-control-enhanced" placeholder="e.g., Cairo University" required>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-3">
                                    <div class="form-group-enhanced">
                                        <button type="submit" class="btn btn-settings-primary w-100">
                                            <i class="tim-icons icon-simple-add"></i> Add University
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Add College -->
<div class="settings-section">
    <div class="section-header"><h5><i class="tim-icons icon-istanbul"></i> Add College</h5></div>
    <form action="{{ url_for('add_college') }}" method="post" class="settings-form">
        <div class="row align-items-end g-3">
           <div class="col-12 col-lg-4">
                <div class="form-group-enhanced">
                    <label>Select University</label>
                    <select name="university_id" class="form-control-enhanced select2-dropdown" required>
                        <option value="">-- Select --</option>
                        {% for university in universities %}<option value="{{ university.id }}">{{ university.name }} ({{ university.country.name }})</option>{% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-12 col-lg-3">
                <div class="form-group-enhanced">
                    <label>College Name</label>
                    <input type="text" name="college_name" class="form-control-enhanced" placeholder="e.g., Faculty of Medicine" required>
                </div>
            </div>
            <!-- === NEW RADIO BUTTONS FOR STRUCTURE === -->
            <div class="col-12 col-lg-3">
                <div class="form-group-enhanced structure-options">
                    <label class="custom-radio">
                        <input type="radio" name="structure_type" value="term" checked> Terms
                    </label>
                    <label class="custom-radio">
                        <input type="radio" name="structure_type" value="module"> Modules
                    </label>
                </div>
            </div>
            <!-- === END OF NEW RADIO BUTTONS === -->
            <div class="col-12 col-lg-2">
                <div class="form-group-enhanced">
                    <button type="submit" class="btn btn-settings-primary w-100">
                        <i class="tim-icons icon-simple-add"></i> Add College
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>



                    <!-- Manage Existing Data -->
                    <div class="text-center mt-5">
                        <button class="btn btn-manage-toggle" type="button" data-toggle="collapse" data-target="#manageAcademic">
                            <i class="tim-icons icon-bullet-list-67"></i> Manage Existing Academic Data
                        </button>
                    </div>
                    <div class="collapse" id="manageAcademic">
                        <div class="manage-section">
                            <div class="accordion settings-accordion" id="academicAccordion">
                                <!-- Countries -->
                                <div class="accordion-item">
                                    <div class="accordion-header"><button class="accordion-btn" type="button" data-toggle="collapse" data-target="#collapseCountries"><span><i class="tim-icons icon-world"></i> Manage Countries</span><i class="tim-icons icon-minimal-down"></i></button></div>
                                    <div id="collapseCountries" class="collapse show" data-parent="#academicAccordion">
                                        <div class="accordion-content"><div class="table-responsive"><table class="table settings-table"><tbody>
                                            {% for country in countries %}
                                            <tr>
                                                <td><strong>{{ country.name }}</strong></td>
                                                <td class="text-right">
                                                    <a href="{{ url_for('edit_country', country_id=country.id) }}" class="btn btn-action btn-edit"><i class="tim-icons icon-pencil"></i> Edit</a>
                                                    <form action="{{ url_for('delete_country', country_id=country.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody></table></div></div>
                                    </div>
                                </div>
                                <!-- Universities -->
                                <div class="accordion-item">
                                    <div class="accordion-header"><button class="accordion-btn collapsed" type="button" data-toggle="collapse" data-target="#collapseUniversities"><span><i class="tim-icons icon-bank"></i> Manage Universities</span><i class="tim-icons icon-minimal-down"></i></button></div>
                                    <div id="collapseUniversities" class="collapse" data-parent="#academicAccordion">
                                        <div class="accordion-content"><div class="table-responsive"><table class="table settings-table"><tbody>
                                            {% for university in universities %}
                                            <tr>
                                                <td><strong>{{ university.name }}</strong><span class="table-meta">{{ university.country.name }}</span></td>
                                                <td class="text-right">
                                                    <a href="{{ url_for('edit_university', university_id=university.id) }}" class="btn btn-action btn-edit"><i class="tim-icons icon-pencil"></i> Edit</a>
                                                    <form action="{{ url_for('delete_university', university_id=university.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody></table></div></div>
                                    </div>
                                </div>

<!-- Colleges -->
<div class="accordion-item">
    <div class="accordion-header"><button class="accordion-btn collapsed" type="button" data-toggle="collapse" data-target="#collapseColleges"><span><i class="tim-icons icon-istanbul"></i> Manage Colleges</span><i class="tim-icons icon-minimal-down"></i></button></div>
    <div id="collapseColleges" class="collapse" data-parent="#academicAccordion">
        <div class="accordion-content"><div class="table-responsive"><table class="table settings-table"><tbody>
            {% for college in colleges %}
            <tr>
                <td>
                    <strong>{{ college.name }}</strong>
                    <!-- === NEW BADGE TO SHOW STRUCTURE TYPE === -->
                    {% if college.structure_type == 'term' %}
                        <span class="badge badge-info ml-2">Term-based</span>
                    {% elif college.structure_type == 'module' %}
                        <span class="badge badge-success ml-2">Module-based</span>
                    {% endif %}
                    <!-- === END OF NEW BADGE === -->
                    <span class="table-meta">{{ college.university.name }}</span>
                </td>
                <td class="text-right">
                    <a href="{{ url_for('edit_college', college_id=college.id) }}" class="btn btn-action btn-edit"><i class="tim-icons icon-pencil"></i> Edit</a>
                    <form action="{{ url_for('delete_college', college_id=college.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                </td>
            </tr>
            {% endfor %}
        </tbody></table></div></div>
    </div>
</div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Tab -->
                <div class="tab-pane fade {% if active_tab == 'financial' %}show active{% endif %}" id="financial">
                    <div class="settings-section">
    <div class="section-header"><h5><i class="tim-icons icon-book-bookmark"></i> Add New Subject</h5></div>
    <form action="{{ url_for('add_subject') }}" method="post" class="settings-form">
        <div class="row">
            <div class="col-md-6"><div class="form-group-enhanced"><label>Subject Name</label><input type="text" name="subject_name" class="form-control-enhanced" placeholder="e.g., Anatomy 101" required></div></div>
            
            <!-- === CHANGED YEAR TO A DROPDOWN === -->
            <div class="col-md-2">
                <div class="form-group-enhanced">
                    <label>Year</label>
                    <select id="subject-year-select" name="year" class="form-control-enhanced select2-dropdown" required>
                        <option value="">-- Select College First --</option>
                    </select>
                </div>
            </div>
            
            <!-- === DYNAMIC TERM/MODULE DROPDOWNS === -->
            <div class="col-md-4">
                <div id="term-select-wrapper" style="display: none;">
                    <div class="form-group-enhanced">
                        <label>Term</label>
                        <select id="term-select" name="term_id" class="form-control-enhanced select2-dropdown"></select>
                    </div>
                </div>
                <div id="module-select-wrapper" style="display: none;">
                    <div class="form-group-enhanced">
                        <label>Module</label>
                        <select id="module-select" name="module_id" class="form-control-enhanced select2-dropdown"></select>
                    </div>
                </div>
            </div>
            <!-- === END OF DYNAMIC DROPDOWNS === -->

        </div>
        <div class="row">
           <div class="col-12 col-lg-4"><div class="form-group-enhanced"><label>Course Price</label><input type="number" step="0.01" name="course_price" class="form-control-enhanced" value="0" required></div></div>
            <div class="col-md-4"><div class="form-group-enhanced"><label>Application Price</label><input type="number" step="0.01" name="app_price" class="form-control-enhanced" value="0" required></div></div>
            <div class="col-md-4"><div class="form-group-enhanced"><label>Currency</label><select name="currency_id" class="form-control-enhanced select2-dropdown" required>{% for currency in currencies %}<option value="{{ currency.id }}">{{ currency.code }}</option>{% endfor %}</select></div></div>
        </div>
        <div class="row">
            <div class="col-md-6"><div class="form-group-enhanced"><label>College</label><select id="subject-college-select" name="college_id" class="form-control-enhanced select2-dropdown" required><option value="">-- Select College --</option>{% for college in colleges %}<option value="{{ college.id }}">{{ college.name }} ({{ college.university.name }})</option>{% endfor %}</select></div></div>
            <div class="col-md-6"><div class="form-group-enhanced"><label>Instructor</label><select name="instructor_id" class="form-control-enhanced select2-dropdown"><option value="">-- None --</option>{% for instructor in instructors %}<option value="{{ instructor.id }}">{{ instructor.name }}</option>{% endfor %}</select></div></div>
        </div>
        <div class="row"><div class="col-md-12 text-right"><button type="submit" class="btn btn-settings-primary"><i class="tim-icons icon-simple-add"></i> Add Subject</button></div></div>
    </form>
</div>

                    <div class="text-center mt-5"><button class="btn btn-manage-toggle" type="button" data-toggle="collapse" data-target="#manageSubjects"><i class="tim-icons icon-bullet-list-67"></i> Manage Existing Subjects</button></div>
                    <div class="collapse" id="manageSubjects">
                        <div class="manage-section"><div class="accordion settings-accordion" id="financialAccordion"><div class="accordion-item">
                            <div class="accordion-header"><button class="accordion-btn" type="button" data-toggle="collapse" data-target="#collapseSubjects"><span><i class="tim-icons icon-book-bookmark"></i> Manage Subjects</span><i class="tim-icons icon-minimal-down"></i></button></div>
                            <div id="collapseSubjects" class="collapse show" data-parent="#financialAccordion"><div class="accordion-content"><div class="table-responsive"><table class="table settings-table">
                                <thead><tr><th>Subject</th><th>College</th><th>Price</th><th class="text-right">Actions</th></tr></thead>
                                <tbody>
                                    {% for subject in subjects %}
                                    <tr>
                                        <td><strong>{{ subject.name }}</strong><span class="table-meta">Year {{ subject.year }}</span></td>
                                        <td>{{ subject.college.name }}</td>
                                        <td>{{ "%.2f"|format(subject.default_course_price + subject.default_application_price) }} {{ subject.currency.symbol }}</td>
                                        <td class="text-right">
                                            <a href="{{ url_for('edit_subject', subject_id=subject.id) }}" class="btn btn-action btn-edit"><i class="tim-icons icon-pencil"></i> Edit</a>
                                            <form action="{{ url_for('delete_subject', subject_id=subject.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table></div></div></div>
                        </div></div></div>
                    </div>
                </div>


                <!-- === Structure === -->
                                 <div class="tab-pane fade {% if active_tab == 'structure' %}show active{% endif %}" id="structure">
                    <div class="row">
                        <!-- Column for College Years -->
                        <div class="col-md-4">
                            <div class="settings-section">
                                <div class="section-header"><h5><i class="tim-icons icon-puzzle-10"></i> Manage College Years</h5></div>
                                <!-- Add College Year Form -->
                                <form action="{{ url_for('add_college_year') }}" method="post" class="settings-form">
                                    <div class="row align-items-end">
                                        <div class="col-12">
                                            <div class="form-group-enhanced">
                                                <label>Select College</label>
                                                <select name="college_id" class="form-control-enhanced select2-dropdown" required>
                                                    <option value="">-- Select a College --</option>
                                                    {% for college in colleges %}
                                                        <option value="{{ college.id }}">{{ college.name }} ({{ college.university.name }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-7">
                                            <div class="form-group-enhanced">
                                                <label>Year Number</label>
                                                <input type="number" name="year_number" class="form-control-enhanced" placeholder="e.g., 1" required>
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <div class="form-group-enhanced">
                                                <button type="submit" class="btn btn-settings-primary w-100">
                                                    <i class="tim-icons icon-simple-add"></i> Add Year
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <!-- Manage Existing College Years Table -->
                                <div class="manage-section mt-4">
                                    <div class="table-responsive"><table class="table settings-table"><tbody>
                                        {% for college in colleges %}
                                            {% if college.defined_years.all() %}
                                                <tr>
                                                    <td colspan="2" class="table-group-header">{{ college.name }}</td>
                                                </tr>
                                                {% for year in college.defined_years.order_by('year_number') %}
                                                <tr>
                                                    <td><strong>Year {{ year.year_number }}</strong></td>
                                                    <td class="text-right">
                                                        <form action="{{ url_for('delete_college_year', year_id=year.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    </tbody></table></div>
                                </div>
                            </div>
                        </div>

                        <!-- Column for Terms -->
                        <div class="col-md-4">
                            <div class="settings-section">
                                <div class="section-header"><h5><i class="tim-icons icon-calendar-60"></i> Manage Terms</h5></div>
                                <!-- Add Term Form -->
                                <form action="{{ url_for('add_term') }}" method="post" class="settings-form">
                                    <div class="row align-items-end">
                                        <div class="col-12">
                                            <div class="form-group-enhanced">
                                                <label>Select College (Term-based)</label>
                                                <!-- === ADDED ID === -->
                                                <select id="term-college-select" name="college_id" class="form-control-enhanced select2-dropdown" required>
                                                    <option value="">-- Select a College --</option>
                                                    {% for college in colleges if college.structure_type == 'term' %}
                                                        <option value="{{ college.id }}">{{ college.name }} ({{ college.university.name }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <!-- === CHANGED TO DROPDOWN === -->
                                        <div class="col-12">
                                            <div class="form-group-enhanced">
                                                <label>For Year</label>
                                                <select id="term-year-select" name="year" class="form-control-enhanced select2-dropdown" required>
                                                    <option value="">-- Select College First --</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <div class="form-group-enhanced">
                                                <label>New Term Name</label>
                                                <input type="text" name="term_name" class="form-control-enhanced" placeholder="e.g., Term 1" required>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="form-group-enhanced">
                                                <button type="submit" class="btn btn-settings-primary w-100">
                                                    <i class="tim-icons icon-simple-add"></i> Add Term
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <!-- Manage Existing Terms Table -->
                                <div class="manage-section mt-4">
                                    <div class="table-responsive"><table class="table settings-table"><tbody>
                                        {% for term in all_terms %}
                                        <tr>
                                            <td>
                                                <strong>{{ term.name }}</strong>
                                                <span class="table-meta">{{ term.college.name }} - Year {{ term.year }}</span>
                                            </td>
                                            <td class="text-right">
                                                <form action="{{ url_for('delete_term', term_id=term.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody></table></div>
                                </div>
                            </div>
                        </div>

                        <!-- Column for Modules -->
                        <div class="col-md-4">
                            <div class="settings-section">
                                <div class="section-header"><h5><i class="tim-icons icon-bullet-list-67"></i> Manage Modules</h5></div>
                                <!-- Add Module Form -->
                                <form action="{{ url_for('add_module') }}" method="post" class="settings-form">
                                    <div class="row align-items-end">
                                        <div class="col-12">
                                            <div class="form-group-enhanced">
                                                <label>Select College (Module-based)</label>
                                                <!-- === ADDED ID === -->
                                                <select id="module-college-select" name="college_id" class="form-control-enhanced select2-dropdown" required>
                                                    <option value="">-- Select a College --</option>
                                                    {% for college in colleges if college.structure_type == 'module' %}
                                                        <option value="{{ college.id }}">{{ college.name }} ({{ college.university.name }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <!-- === CHANGED TO DROPDOWN === -->
                                        <div class="col-12">
                                            <div class="form-group-enhanced">
                                                <label>For Year</label>
                                                <select id="module-year-select" name="year" class="form-control-enhanced select2-dropdown" required>
                                                    <option value="">-- Select College First --</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <div class="form-group-enhanced">
                                                <label>New Module Name</label>
                                                <input type="text" name="module_name" class="form-control-enhanced" placeholder="e.g., Cardiovascular" required>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="form-group-enhanced">
                                                <button type="submit" class="btn btn-settings-primary w-100">
                                                    <i class="tim-icons icon-simple-add"></i> Add Module
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <!-- Manage Existing Modules Table -->
                                <div class="manage-section mt-4">
                                    <div class="table-responsive"><table class="table settings-table"><tbody>
                                        {% for module in all_modules %}
                                        <tr>
                                            <td>
                                                <strong>{{ module.name }}</strong>
                                                <span class="table-meta">{{ module.college.name }} - Year {{ module.year }}</span>
                                            </td>
                                            <td class="text-right">
                                                <form action="{{ url_for('delete_module', module_id=module.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody></table></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ======================================= -->

                <!-- Instructors Tab -->
                <div class="tab-pane fade {% if active_tab == 'instructors' %}show active{% endif %}" id="instructors">
                    <div class="settings-section">
                        <div class="section-header"><h5><i class="tim-icons icon-badge"></i> Add New Instructor</h5></div>
                        <form action="{{ url_for('add_instructor') }}" method="post" class="settings-form">
                            <div class="row">
                                <div class="col-12 col-lg-5"><div class="form-group-enhanced"><label>Instructor Name</label><input type="text" name="instructor_name" class="form-control-enhanced" placeholder="e.g., Dr. Ahmed" required></div></div>
                                <div class="col-md-4"><div class="form-group-enhanced"><label>Email (Optional)</label><input type="email" name="instructor_email" class="form-control-enhanced" placeholder="ahmed@example.com"></div></div>
                                <div class="col-12 col-lg-3"><label>&nbsp;</label><button type="submit" class="btn btn-settings-primary"><i class="tim-icons icon-simple-add"></i> Add Instructor</button></div>
                            </div>
                        </form>
                    </div>
                    <div class="text-center mt-5"><button class="btn btn-manage-toggle" type="button" data-toggle="collapse" data-target="#manageInstructors"><i class="tim-icons icon-bullet-list-67"></i> Manage Existing Instructors</button></div>
                    <div class="collapse" id="manageInstructors">
                        <div class="manage-section"><div class="accordion settings-accordion" id="instructorAccordion"><div class="accordion-item">
                            <div class="accordion-header"><button class="accordion-btn" type="button" data-toggle="collapse" data-target="#collapseInstructors"><span><i class="tim-icons icon-badge"></i> Manage Instructors</span><i class="tim-icons icon-minimal-down"></i></button></div>
                            <div id="collapseInstructors" class="collapse show" data-parent="#instructorAccordion"><div class="accordion-content"><div class="table-responsive"><table class="table settings-table"><tbody>
                                {% for instructor in instructors %}
                                <tr>
                                    <td><strong>{{ instructor.name }}</strong><span class="table-meta">{{ instructor.email or 'No Email' }}</span></td>
                                    <td class="text-right">
                                        <a href="{{ url_for('edit_instructor', instructor_id=instructor.id) }}" class="btn btn-action btn-edit"><i class="tim-icons icon-pencil"></i> Edit</a>
                                        <form action="{{ url_for('delete_instructor', instructor_id=instructor.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn btn-action btn-delete"><i class="tim-icons icon-trash-simple"></i> Delete</button></form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody></table></div></div></div>
                        </div></div></div>
                    </div>
                </div>

                <!-- Data Import Tab -->
                <div class="tab-pane fade {% if active_tab == 'import' %}show active{% endif %}" id="import">
                    <div class="import-section">
                        <div class="import-header">
                            <div class="import-icon"><i class="tim-icons icon-cloud-upload-94"></i></div>
                            <h5>Import Customers from File</h5>
                            <p>Upload Excel (.xlsx) or CSV (.csv) files to bulk import customer data</p>
                        </div>
                        <div class="import-instructions">
                            <h6><i class="tim-icons icon-alert-circle-exc"></i> Required Columns:</h6>
                            <div class="columns-list">
                                <span class="column-badge">full_name</span><span class="column-badge">email</span><span class="column-badge">whatsapp_number</span><span class="column-badge">year</span><span class="column-badge">country</span><span class="column-badge">university</span><span class="column-badge">college</span>
                            </div>
                            <p class="mt-3">
                                <i class="tim-icons icon-bulb-63"></i> The system will automatically match country, university, and college names to existing records.
                                <a href="{{ url_for('static', filename='assets/sample/sample_import.xlsx') }}" class="download-link"><i class="tim-icons icon-cloud-download-93"></i> Download sample template</a>
                            </p>
                        </div>
                        <form action="{{ url_for('import_customers') }}" method="post" enctype="multipart/form-data" class="import-form">
                            <div class="file-upload-container">
                                <div class="file-upload-area">
                                    <input type="file" name="import_file" id="import_file" required>
                                    <label for="import_file" class="file-upload-label">
                                        <div class="upload-icon"><i class="tim-icons icon-upload"></i></div>
                                        <div class="upload-text">
                                            <span class="upload-title">Choose File</span>
                                            <span class="upload-subtitle" id="file-chosen">No file selected</span>
                                        </div>
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-upload"><i class="tim-icons icon-check-2"></i> Upload and Import</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot HTML -->
    <div id="chatbot-container" class="chatbot-hidden">
        <img src="{{ url_for('static', filename='assets/img/chat.jpg') }}" alt="عبدالمطلب" class="chatbot-avatar">
        <div class="chatbot-message">
            <strong class="chatbot-name">عبدالمطلب</strong>
            <p id="chatbot-text"></p>
        </div>
    </div>

</div>
{% endblock content %}

{% block javascripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Initialize Select2 in tabs
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var newTab = $(e.target).attr('href');
            $(newTab).find('.select2-dropdown').each(function() {
                var $this = $(this);
                if (!$this.data('select2')) {
                    $this.select2({
                        theme: "bootstrap4",
                        dropdownParent: $this.closest('.tab-pane')
                    });
                }
            });
        });
        $('a[data-toggle="tab"].active').trigger('shown.bs.tab');

        // --- START OF DYNAMIC YEAR DROPDOWNS FOR TERM/MODULE FORMS ---
        function setupYearDropdown(collegeSelectId, yearSelectId) {
            const collegeSelect = $(collegeSelectId);
            const yearSelect = $(yearSelectId);

            collegeSelect.on('change', function() {
                const collegeId = $(this).val();
                yearSelect.empty().append('<option value="">Loading...</option>').trigger('change');

                if (collegeId) {
                    fetch(`/api/get_college_years/${collegeId}`)
                        .then(response => response.json())
                        .then(data => {
                            yearSelect.empty().append('<option value="">-- Select Year --</option>');
                            data.years.forEach(year => {
                                yearSelect.append(new Option(`Year ${year.year_number}`, year.year_number));
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching college years:', error);
                            yearSelect.empty().append('<option value="">Error loading years</option>');
                        });
                } else {
                    yearSelect.empty().append('<option value="">-- Select College First --</option>');
                }
            });
        }

        // Initialize the logic for both Term and Module forms in the "Structure" tab
        setupYearDropdown('#term-college-select', '#term-year-select');
        setupYearDropdown('#module-college-select', '#module-year-select');
        // --- END OF DYNAMIC YEAR DROPDOWNS ---

        // --- START OF FINAL DYNAMIC SUBJECT FORM LOGIC ---
        const subjectCollegeSelect = $('#subject-college-select');
        const subjectYearSelect = $('#subject-year-select');
        const termWrapper = $('#term-select-wrapper');
        const moduleWrapper = $('#module-select-wrapper');
        const termSelect = $('#term-select');
        const moduleSelect = $('#module-select');

        // This function runs when the College dropdown in the "Add Subject" form changes
        subjectCollegeSelect.on('change', function() {
            const collegeId = $(this).val();
            
            // Reset everything downstream
            subjectYearSelect.empty().append('<option value="">Loading...</option>').trigger('change');
            termWrapper.slideUp(200);
            moduleWrapper.slideUp(200);

            if (collegeId) {
                // Fetch the defined years for the selected college
                fetch(`/api/get_college_years/${collegeId}`)
                    .then(response => response.json())
                    .then(data => {
                        subjectYearSelect.empty().append('<option value="">-- Select Year --</option>');
                        data.years.forEach(year => {
                            subjectYearSelect.append(new Option(`Year ${year.year_number}`, year.year_number));
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching college years:', error);
                        subjectYearSelect.empty().append('<option value="">Error</option>');
                    });
            } else {
                subjectYearSelect.empty().append('<option value="">-- Select College First --</option>');
            }
        });

        // This function runs when the new Year dropdown in the "Add Subject" form changes
        subjectYearSelect.on('change', function() {
            const collegeId = subjectCollegeSelect.val();
            const year = $(this).val();

            // Reset the term/module wrappers
            termWrapper.slideUp(200);
            moduleWrapper.slideUp(200);

            if (collegeId && year) {
                // Fetch the college's structure type
                fetch(`/api/get_college_structure/${collegeId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.structure_type === 'term') {
                            // Fetch the terms for the selected college and year
                            fetch(`/api/get_terms/${collegeId}/${year}`)
                                .then(response => response.json())
                                .then(termData => {
                                    termSelect.empty().append('<option value="">-- Select Term --</option>');
                                    termData.terms.forEach(term => {
                                        termSelect.append(new Option(term.name, term.id));
                                    });
                                    termWrapper.slideDown(200);
                                });
                        } else if (data.structure_type === 'module') {
                            // Fetch the modules for the selected college and year
                            fetch(`/api/get_modules/${collegeId}/${year}`)
                                .then(response => response.json())
                                .then(moduleData => {
                                    moduleSelect.empty().append('<option value="">-- Select Module --</option>');
                                    moduleData.modules.forEach(module => {
                                        moduleSelect.append(new Option(module.name, module.id));
                                    });
                                    moduleWrapper.slideDown(200);
                                });
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        });
        // --- END OF FINAL DYNAMIC SUBJECT FORM LOGIC ---

        // --- Other existing JavaScript ---
        $('#import_file').on('change', function(){
            const fileName = this.files[0] ? this.files[0].name : 'No file selected';
            $('#file-chosen').text(fileName);
        });

        $('.accordion-btn').on('click', function() {
            $(this).find('.icon-minimal-down').toggleClass('rotated');
        });

        function showChatbotMessage(text, type = 'success') {
            const chatbotContainer = document.getElementById('chatbot-container');
            const chatbotText = document.getElementById('chatbot-text');
            chatbotContainer.classList.remove('chatbot-success', 'chatbot-danger');
            if (type === 'success') {
                chatbotContainer.classList.add('chatbot-success');
            } else if (type === 'danger') {
                chatbotContainer.classList.add('chatbot-danger');
            }
            chatbotText.textContent = text;
            chatbotContainer.classList.remove('chatbot-hidden');
            chatbotContainer.classList.add('chatbot-visible');
            setTimeout(() => {
                chatbotContainer.classList.remove('chatbot-visible');
                chatbotContainer.classList.add('chatbot-hidden');
            }, 5000);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        const messageType = urlParams.get('type');

        if (message) {
            showChatbotMessage(message, messageType);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });
</script>
{% endblock javascripts %}
