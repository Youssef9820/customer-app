{% extends "layouts/base.html" %}

{% block title %}Record Payment{% endblock %}

{% block page_title %}Record Payment{% endblock %}

{% block content %}

<style>
    /* Progress Steps */
    .payment-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        padding: 20px 0;
        overflow-x: auto;
    }

    .step {
        display: flex;
        align-items: center;
        position: relative;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
        transition: all 0.3s;
    }

    .step-label {
        margin-left: 10px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 500;
        transition: all 0.3s;
        white-space: nowrap;
    }

    .step.active .step-circle {
        background-color: #e14eca;
        border-color: #e14eca;
        color: #fff;
        box-shadow: 0 0 20px rgba(225, 78, 202, 0.5);
    }

    .step.active .step-label {
        color: #fff;
    }

    .step.completed .step-circle {
        background-color: #00f2c3;
        border-color: #00f2c3;
        color: #1e1e2e;
    }

    .step.completed .step-label {
        color: #00f2c3;
    }

    .step-connector {
        width: 60px;
        height: 2px;
        background-color: rgba(255, 255, 255, 0.2);
        margin: 0 10px;
    }

    .step.completed ~ .step .step-connector {
        background-color: #00f2c3;
    }

    /* Make completed steps clickable */
    .step.completed {
        cursor: pointer;
    }

    .step.completed:hover .step-circle {
        transform: scale(1.1);
        box-shadow: 0 0 25px rgba(0, 242, 195, 0.7);
    }

    .step.completed:hover .step-label {
        color: #00f2c3;
    }

    /* Section Styling */
    .payment-section {
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
        animation: fadeIn 0.3s ease-in;
    }

    .payment-section.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #e14eca;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        font-size: 1.3rem;
    }

    /* Faculty Selection Cards */
    .faculty-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .faculty-card {
        background: linear-gradient(135deg, rgba(225, 78, 202, 0.1) 0%, rgba(29, 140, 248, 0.1) 100%);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .faculty-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #e14eca 0%, #1d8cf8 100%);
        transform: scaleX(0);
        transition: transform 0.3s;
    }

    .faculty-card:hover {
        border-color: rgba(225, 78, 202, 0.5);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(225, 78, 202, 0.2);
    }

    .faculty-card:hover::before {
        transform: scaleX(1);
    }

    .faculty-card.selected {
        border-color: #e14eca;
        background: linear-gradient(135deg, rgba(225, 78, 202, 0.2) 0%, rgba(29, 140, 248, 0.2) 100%);
        box-shadow: 0 0 30px rgba(225, 78, 202, 0.3);
    }

    .faculty-card.selected::before {
        transform: scaleX(1);
    }

    .faculty-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #e14eca 0%, #1d8cf8 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
    }

    .faculty-icon i {
        font-size: 24px;
        color: #fff;
    }

    .faculty-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .faculty-university {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .faculty-university i {
        font-size: 12px;
    }

    .faculty-stats {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .faculty-card .checkmark {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        background: #00f2c3;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .faculty-card.selected .checkmark {
        display: flex;
    }

    .checkmark i {
        color: #1e1e2e;
        font-size: 14px;
    }

    /* Search Box for Faculty */
    .faculty-search {
        margin-bottom: 20px;
    }

    .faculty-search input {
        width: 100%;
        padding: 12px 15px 12px 45px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 0.95rem;
    }

    .faculty-search {
        position: relative;
    }

    .faculty-search i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #9A9A9A;
        font-size: 16px;
    }

    /* Consistent Form Layout */
    .form-row-custom {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row-custom.two-col {
        grid-template-columns: repeat(2, 1fr);
    }

    .form-row-custom.one-col {
        grid-template-columns: 1fr;
    }

    @media (max-width: 992px) {
        .form-row-custom {
            grid-template-columns: 1fr;
        }
        
        .faculty-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-group-custom {
        display: flex;
        flex-direction: column;
    }

    .form-group-custom label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.8);
    }

    .form-group-custom label i {
        margin-right: 5px;
        color: #e14eca;
    }

    /* Price Display */
    .price-display {
        background-color: rgba(225, 78, 202, 0.1);
        border: 1px solid rgba(225, 78, 202, 0.3);
        border-radius: 4px;
        padding: 15px;
        text-align: center;
    }

    .price-label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 5px;
    }

    .price-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #e14eca;
    }

    /* Selected Info Box */
    .selected-info {
        background-color: rgba(0, 242, 195, 0.1);
        border-left: 3px solid #00f2c3;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .selected-info-label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 5px;
    }

    .selected-info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #00f2c3;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 30px;
    }

    .action-buttons .btn {
        min-width: 120px;
    }

    /* Select2 Customization */
    .select2-container--bootstrap4 .select2-selection--single {
        height: 42px !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        background-color: rgba(255, 255, 255, 0.05) !important;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
        line-height: 40px !important;
        color: #fff !important;
    }

    .form-control {
        height: 42px;
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: #fff;
    }

    .form-control:focus {
        background-color: rgba(255, 255, 255, 0.08);
        border-color: #e14eca;
        color: #fff;
    }

    textarea.form-control {
        height: auto;
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="title">Record New Payment</h5>
                    <p class="category">Follow the steps below to record a payment</p>
                </div>
                <div class="card-body">
                    
                    <!-- Progress Steps -->
                    <div class="payment-steps">
                        <div class="step active" id="step-indicator-1">
                            <div class="step-circle">1</div>
                            <div class="step-label">Faculty</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" id="step-indicator-2">
                            <div class="step-circle">2</div>
                            <div class="step-label">Customer</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" id="step-indicator-3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Subject</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" id="step-indicator-4">
                            <div class="step-circle">4</div>
                            <div class="step-label">Payment</div>
                        </div>
                    </div>

                    <form action="{{ url_for('main.record_payment') }}" method="post" id="payment-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- STEP 1: Faculty/College Selection -->
                        <div class="payment-section active" id="section-1">
                            <div class="section-title">
                                <i class="tim-icons icon-bank"></i>
                                Select Faculty/College
                            </div>

                            <!-- Search Box -->
                            <div class="faculty-search">
                                <i class="tim-icons icon-zoom-split"></i>
                                <input type="text" id="faculty-search-input" placeholder="Search by faculty or university name...">
                            </div>

                            <!-- Faculty Cards Grid -->
                            <div class="faculty-grid" id="faculty-grid">
                                {% for college in all_colleges %}
                                <div class="faculty-card" 
                                     data-college-id="{{ college.id }}"
                                     data-college-name="{{ college.name }}"
                                     data-university-name="{{ college.university.name }}"
                                     data-search-text="{{ college.name|lower }} {{ college.university.name|lower }}"
                                     onclick="selectFaculty(this)">
                                    <div class="checkmark">
                                        <i class="tim-icons icon-check-2"></i>
                                    </div>
                                    <div class="faculty-icon">
                                        <i class="tim-icons icon-bank"></i>
                                    </div>
                                    <div class="faculty-name">{{ college.name }}</div>
                                    <div class="faculty-university">
                                        <i class="tim-icons icon-square-pin"></i>
                                        <span>{{ college.university.name }}</span>
                                    </div>
                                    <div class="faculty-stats">
                                        <span><i class="tim-icons icon-single-02"></i> Students</span>
                                        <span><i class="tim-icons icon-book-bookmark"></i> Subjects</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- STEP 2: Customer Selection -->
                        <div class="payment-section" id="section-2">
                            <!-- Selected Faculty Info -->
                            <div class="selected-info">
                                <div class="selected-info-label">Selected Faculty</div>
                                <div class="selected-info-value" id="faculty-info"></div>
                            </div>

                            <div class="section-title">
                                <i class="tim-icons icon-single-02"></i>
                                Select Customer
                            </div>

                            <div class="action-buttons" style="margin-top: 0; margin-bottom: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="showSection(1)">
                                    <i class="tim-icons icon-minimal-left"></i> Back to Faculty
                                </button>
                            </div>

                            <div class="form-row-custom one-col">
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-zoom-split"></i>
                                        Search for Customer
                                    </label>
                                    <select id="customer-select" name="customer_id" class="form-control select2-dropdown" required>
                                        <option value="">-- Select a faculty first --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3: Subject Selection -->
                        <div class="payment-section" id="section-3">
                            <!-- Selected Customer Info -->
                            <div class="selected-info">
                                <div class="selected-info-label">Selected Customer</div>
                                <div class="selected-info-value" id="customer-info"></div>
                            </div>

                            <div class="section-title">
                                <i class="tim-icons icon-book-bookmark"></i>
                                Select Year & Subject
                            </div>

                            <div class="action-buttons" style="margin-top: 0; margin-bottom: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="showSection(2)">
                                    <i class="tim-icons icon-minimal-left"></i> Back to Customer
                                </button>
                            </div>

                            <div class="form-row-custom" id="subject-selection-row">
                                <!-- Year Selection (Always shown first) -->
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-hat-3"></i>
                                        Year
                                    </label>
                                    <select id="year-select" class="form-control select2-dropdown" required>
                                        <option value="">-- Select Year --</option>
                                        <option value="1">Year 1</option>
                                        <option value="2">Year 2</option>
                                        <option value="3">Year 3</option>
                                        <option value="4">Year 4</option>
                                        <option value="5">Year 5</option>
                                        <option value="6">Year 6</option>
                                    </select>
                                </div>

                                <div class="form-group-custom" id="term-group" style="display: none;">
                                    <label>
                                        <i class="tim-icons icon-calendar-60"></i>
                                        Term
                                    </label>
                                    <select id="term-select" class="form-control select2-dropdown">
                                        <option value="">-- Select Year First --</option>
                                    </select>
                                </div>

                                <div class="form-group-custom" id="module-group" style="display: none;">
                                    <label>
                                        <i class="tim-icons icon-bullet-list-67"></i>
                                        Module
                                    </label>
                                    <select id="module-select" class="form-control select2-dropdown">
                                        <option value="">-- Select Year First --</option>
                                    </select>
                                </div>

                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-book-bookmark"></i>
                                        Subject
                                    </label>
                                    <select id="subject-select" name="subject_id" class="form-control select2-dropdown" required>
                                        <option value="">-- Select Year & Term/Module First --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 4: Payment Details -->
                        <div class="payment-section" id="section-4">
                            <!-- Selected Subject Info -->
                            <div class="selected-info">
                                <div class="selected-info-label">Selected Subject</div>
                                <div class="selected-info-value" id="subject-info"></div>
                            </div>

                            <div class="section-title">
                                <i class="tim-icons icon-money-coins"></i>
                                Payment Details
                            </div>

                            <!-- Price Display -->
                            <div class="form-row-custom">
                                <div class="price-display">
                                    <div class="price-label">Default Course Price</div>
                                    <div class="price-value" id="default-course-price">0.00</div>
                                </div>
                                <div class="price-display">
                                    <div class="price-label">Default App Price</div>
                                    <div class="price-value" id="default-app-price">0.00</div>
                                </div>
                                <div class="price-display">
                                    <div class="price-label">Total Default</div>
                                    <div class="price-value" id="total-default">0.00</div>
                                </div>
                            </div>

                            <!-- Payment Input Fields -->
                            <div class="form-row-custom">
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-coins"></i>
                                        Course Price Paid
                                    </label>
                                    <input type="number" step="0.01" id="course_price_paid" name="course_price_paid" 
                                           class="form-control" value="0" required min="0">
                                </div>
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-coins"></i>
                                        Application Price Paid
                                    </label>
                                    <input type="number" step="0.01" id="app_price_paid" name="app_price_paid" 
                                           class="form-control" value="0" required min="0">
                                </div>
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-credit-card"></i>
                                        Payment Method
                                    </label>
                                    <select name="payment_method_id" class="form-control select2-dropdown" required>
                                        <option value="">-- Select Method --</option>
                                        {% for method in all_payment_methods %}
                                            <option value="{{ method.id }}">{{ method.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-row-custom one-col">
                                <div class="form-group-custom">
                                    <label>
                                        <i class="tim-icons icon-notes"></i>
                                        Notes (Optional)
                                    </label>
                                    <textarea name="notes" class="form-control" rows="3" 
                                              placeholder="e.g., Discount applied, partial payment, etc."></textarea>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button type="button" class="btn btn-secondary" onclick="showSection(3)">
                                    <i class="tim-icons icon-minimal-left"></i> Back to Subject
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="tim-icons icon-check-2"></i> Save Payment
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Initialize Select2
    $('.select2-dropdown').select2({
        theme: "bootstrap4",
        width: '100%'
    });

    let currentStep = 1;
    let selectedFacultyData = {};
    let selectedCustomerData = {};
    let selectedSubjectData = {};

    // Faculty Search
    $('#faculty-search-input').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.faculty-card').each(function() {
            const searchText = $(this).data('search-text');
            if (searchText.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // Update step indicators
    function updateStepIndicators(step) {
        for (let i = 1; i <= 4; i++) {
            $(`#step-indicator-${i}`).removeClass('active completed');
            if (i < step) {
                $(`#step-indicator-${i}`).addClass('completed');
            } else if (i === step) {
                $(`#step-indicator-${i}`).addClass('active');
            }
        }
    }

    // Show specific section (make it global for onclick)
    window.showSection = function(step) {
        $('.payment-section').removeClass('active');
        $(`#section-${step}`).addClass('active');
        updateStepIndicators(step);
        currentStep = step;
    }

    // Select Faculty (make it global for onclick)
    window.selectFaculty = function(element) {
        // Remove previous selection
        $('.faculty-card').removeClass('selected');
        
        // Add selection to clicked card
        $(element).addClass('selected');

        // Store faculty data
        selectedFacultyData = {
            id: $(element).data('college-id'),
            name: $(element).data('college-name'),
            universityName: $(element).data('university-name')
        };

        // Update faculty info display
        $('#faculty-info').html(`${selectedFacultyData.name} <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">(${selectedFacultyData.universityName})</span>`);

        // Fetch customers from this college
        fetch(`/api/get_customers_by_college/${selectedFacultyData.id}`)
            .then(response => response.json())
            .then(data => {
                const customerSelect = $('#customer-select');
                customerSelect.empty().append('<option value="">-- Type to search for a customer --</option>');
                
                data.customers.forEach(customer => {
                    const option = new Option(
                        `${customer.full_name} - ${customer.college_name} (Year ${customer.year})`,
                        customer.id
                    );
                    $(option).data('college-id', customer.college_id);
                    $(option).data('college-name', customer.college_name);
                    $(option).data('university-name', customer.university_name);
                    $(option).data('year', customer.year);
                    $(option).data('full-name', customer.full_name);
                    customerSelect.append(option);
                });
                
                customerSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });
                
                // Move to step 2
                showSection(2);
            })
            .catch(error => {
                console.error('Error fetching customers:', error);
                alert('Error loading customers. Please try again.');
            });
    }

    // Calculate total
    function updateTotal() {
        const coursePrice = parseFloat($('#course_price_paid').val()) || 0;
        const appPrice = parseFloat($('#app_price_paid').val()) || 0;
        $('#total-default').text((coursePrice + appPrice).toFixed(2));
    }

    // STEP 2: Customer Selection
    $('#customer-select').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const customerId = selectedOption.val();

        if (!customerId) return;

        selectedCustomerData = {
            id: customerId,
            name: selectedOption.data('full-name'),
            collegeId: selectedOption.data('college-id'),
            collegeName: selectedOption.data('college-name'),
            universityName: selectedOption.data('university-name'),
            year: selectedOption.data('year')
        };

        // Update customer info display
        $('#customer-info').text(`${selectedCustomerData.name} - ${selectedCustomerData.collegeName} (Year ${selectedCustomerData.year})`);

        // Fetch college structure type
        fetch(`/api/get_college_structure/${selectedCustomerData.collegeId}`)
            .then(response => response.json())
            .then(data => {
                selectedCustomerData.structureType = data.structure_type;

                // Show appropriate dropdown based on structure type
                if (data.structure_type === 'term') {
                    $('#term-group').show();
                    $('#module-group').hide();
                } else {
                    $('#module-group').show();
                    $('#term-group').hide();
                }

                // Reset year, term, module, and subject selects
                $('#year-select').val('').trigger('change');
                $('#term-select').empty().append('<option value="">-- Select Year First --</option>').trigger('change');
                $('#module-select').empty().append('<option value="">-- Select Year First --</option>').trigger('change');
                $('#subject-select').empty().append('<option value="">-- Select Year & Term/Module First --</option>').trigger('change');

                // Move to step 3
                showSection(3);
            });
    });

    // Year selection handler
    $('#year-select').on('change', function() {
        const selectedYear = $(this).val();

        if (!selectedYear) {
            // Reset term/module and subject
            $('#term-select').empty().append('<option value="">-- Select Year First --</option>').trigger('change');
            $('#module-select').empty().append('<option value="">-- Select Year First --</option>').trigger('change');
            $('#subject-select').empty().append('<option value="">-- Select Year & Term/Module First --</option>').trigger('change');
            return;
        }

        // Fetch terms or modules based on structure type
        if (selectedCustomerData.structureType === 'term') {
            // Fetch terms for this year
            fetch(`/api/get_terms/${selectedCustomerData.collegeId}/${selectedYear}`)
                .then(response => response.json())
                .then(termData => {
                    const termSelect = $('#term-select');
                    termSelect.empty().append('<option value="">-- Select Term --</option>');
                    
                    termData.terms.forEach(term => {
                        termSelect.append(new Option(term.name, term.id));
                    });
                    
                    termSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });

                    // Auto-select if only one term
                    if (termData.terms.length === 1) {
                        termSelect.val(termData.terms[0].id).trigger('change');
                    }
                });
        } else {
            // Fetch modules for this year
            fetch(`/api/get_modules/${selectedCustomerData.collegeId}/${selectedYear}`)
                .then(response => response.json())
                .then(moduleData => {
                    const moduleSelect = $('#module-select');
                    moduleSelect.empty().append('<option value="">-- Select Module --</option>');
                    
                    moduleData.modules.forEach(module => {
                        moduleSelect.append(new Option(module.name, module.id));
                    });
                    
                    moduleSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });

                    // Auto-select if only one module
                    if (moduleData.modules.length === 1) {
                        moduleSelect.val(moduleData.modules[0].id).trigger('change');
                    }
                });
        }
    });

    // Fetch subjects when term/module changes
    function fetchSubjects() {
        const selectedYear = $('#year-select').val();
        const termId = $('#term-select').val();
        const moduleId = $('#module-select').val();
        const subjectSelect = $('#subject-select');

        // Ensure year is selected
        if (!selectedYear) {
            subjectSelect.empty().append('<option value="">-- Select Year First --</option>');
            subjectSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });
            return;
        }

        let apiUrl = `/api/get_subjects?college_id=${selectedCustomerData.collegeId}&year=${selectedYear}`;
        
        if (selectedCustomerData.structureType === 'term' && termId) {
            apiUrl += `&term_id=${termId}`;
        } else if (selectedCustomerData.structureType === 'module' && moduleId) {
            apiUrl += `&module_id=${moduleId}`;
        } else {
            subjectSelect.empty().append('<option value="">-- Select Term/Module First --</option>');
            subjectSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });
            return;
        }

        subjectSelect.empty().append('<option value="">Loading...</option>').trigger('change');

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                subjectSelect.empty().append('<option value="">-- Select Subject --</option>');
                data.subjects.forEach(sub => {
                    const option = new Option(sub.name, sub.id);
                    $(option).data('course-price', sub.course_price);
                    $(option).data('app-price', sub.app_price);
                    $(option).data('name', sub.name);
                    subjectSelect.append(option);
                });
                subjectSelect.select2('destroy').select2({ theme: "bootstrap4", width: '100%' });
            });
    }

    $('#term-select, #module-select').on('change', fetchSubjects);

    // STEP 3: Subject Selection
    $('#subject-select').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const subjectId = selectedOption.val();

        if (!subjectId) return;

        selectedSubjectData = {
            id: subjectId,
            name: selectedOption.data('name'),
            coursePrice: selectedOption.data('course-price') || 0,
            appPrice: selectedOption.data('app-price') || 0
        };

        // Update displays
        $('#subject-info').text(selectedSubjectData.name);
        $('#default-course-price').text(selectedSubjectData.coursePrice.toFixed(2));
        $('#default-app-price').text(selectedSubjectData.appPrice.toFixed(2));
        $('#course_price_paid').val(selectedSubjectData.coursePrice.toFixed(2));
        $('#app_price_paid').val(selectedSubjectData.appPrice.toFixed(2));
        
        updateTotal();

        // Move to step 4
        showSection(4);
    });

    // Update total when prices change
    $('#course_price_paid, #app_price_paid').on('input', updateTotal);

    // Make step indicators clickable (only for completed steps)
    $('.payment-steps').on('click', '.step.completed', function() {
        const stepNum = parseInt($(this).attr('id').split('-')[2]);
        showSection(stepNum);
    });
});
</script>
{% endblock javascripts %}