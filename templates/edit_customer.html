{% extends "layouts/base.html" %}

{% block title %} Edit Customer {% endblock %}

{% block content %}

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="title">Edit Customer: {{ customer.full_name }}</h5>
                </div>
                <div class="card-body">
                    <!-- The action now points to the edit route, passing the customer's ID -->
                    <<a href="{{ url_for('main.edit_customer', customer_id=customer.id) }}" class="btn btn-primary btn-round btn-lg">Edit Profile</a>
                        <div class="row">
                            <div class="col-md-4 pr-md-1">
                                <div class="form-group">
                                    <label>Country</label>
                                    <!-- Dropdowns are more complex to pre-select, we'll handle this with JS -->
                                    <select id="country" name="country_id" class="form-control" required>
                                        <option value="">-- Select a Country --</option>
                                        {% for country in countries %}
                                            <option value="{{ country.id }}" {% if customer.college.university.country_id == country.id %}selected{% endif %}>{{ country.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 px-md-1">
                                <div class="form-group">
                                    <label>University</label>
                                    <select id="university" name="university_id" class="form-control" required>
                                        <!-- This will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 pl-md-1">
                                <div class="form-group">
                                    <label>College</label>
                                    <select id="college" name="college_id" class="form-control" required>
                                        <!-- This will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 pr-md-1">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <!-- Use the 'value' attribute to pre-fill the input -->
                                    <input type="text" name="full_name" class="form-control" placeholder="Full Name" value="{{ customer.full_name }}" required>
                                </div>
                            </div>
                            <div class="col-md-4 pl-md-1">
                                <div class="form-group">
                                    <label>Year</label>
                                    <input type="number" name="year" class="form-control" placeholder="e.g., 2025" value="{{ customer.year or '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 pr-md-1">
                                <div class="form-group">
                                    <label>Email address</label>
                                    <input type="email" name="email" class="form-control" placeholder="mike@email.com" value="{{ customer.email or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6 pl-md-1">
                                <div class="form-group">
                                    <label>WhatsApp Number</label>
                                    <input type="text" name="whatsapp_number" class="form-control" placeholder="WhatsApp Number" value="{{ customer.whatsapp_number or '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <!-- Change button text -->
                            <button type="submit" class="btn btn-fill btn-primary">Save Changes</button>
                            <a href="{{ url_for('main.view_customers') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Select2 (اختياري)
  if (window.$ && $.fn.select2) {
    $('#country').select2({ theme: 'bootstrap4' });
    $('#university').select2({ theme: 'bootstrap4' });
    $('#college').select2({ theme: 'bootstrap4' });
  }

  const countrySelect = document.getElementById('country');
  const universitySelect = document.getElementById('university');
  const collegeSelect = document.getElementById('college');

  const initialUniversityId = "{{ customer.college.university_id }}";
  const initialCollegeId = "{{ customer.college_id }}";

  function updateSelect(selectElement, options, placeholder, selectedId) {
    selectElement.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = placeholder;
    selectElement.appendChild(ph);

    options.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.name;
      if (String(o.id) === String(selectedId)) opt.selected = true;
      selectElement.appendChild(opt);
    });

    // أعِد تهيئة Select2 لو شغال
    if (window.$ && $.fn.select2) $(selectElement).trigger('change.select2');
  }

  function loadUniversities(countryId, selectedUniversityId) {
    if (!countryId) return;
    fetch(`/api_get_universities/${countryId}`)
      .then(r => r.json())
      .then(data => {
        updateSelect(universitySelect, data.universities, '-- Select a University --', selectedUniversityId);
        if (selectedUniversityId) loadColleges(selectedUniversityId, initialCollegeId);
      });
  }

  function loadColleges(universityId, selectedCollegeId) {
    if (!universityId) return;
    fetch(`/api_get_colleges/${universityId}`)
      .then(r => r.json())
      .then(data => {
        updateSelect(collegeSelect, data.colleges, '-- Select a College --', selectedCollegeId);
      });
  }

  countrySelect.addEventListener('change', () => {
    updateSelect(universitySelect, [], '-- Select a University --', null);
    updateSelect(collegeSelect, [], '-- Select a College --', null);
    loadUniversities(countrySelect.value, null);
  });

  universitySelect.addEventListener('change', () => {
    updateSelect(collegeSelect, [], '-- Select a College --', null);
    loadColleges(universitySelect.value, null);
  });

  // Initial load بناءً على الدولة المحددة مسبقًا
  if (countrySelect.value) {
    loadUniversities(countrySelect.value, initialUniversityId);
  }
});
</script>
{% endblock javascripts %}
