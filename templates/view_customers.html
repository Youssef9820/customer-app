{% extends "layouts/base.html" %}

{% block title %} View Customers {% endblock %}

{% block content %}

<style>
    /* --- START: Flexbox Fix for Filters --- */

    /* 1. Create the Flex Container */
    .filter-container {
        display: flex;  /* Activates Flexbox */
        flex-wrap: wrap; /* This is the magic: allows items to wrap to the next line */
        gap: 1rem;       /* Creates consistent spacing between all filter items */
        margin-bottom: 1rem; /* Space below the entire filter block */
    }

    /* 2. Define the Flex Items (the filters themselves) */
    .filter-item {
        flex-grow: 1;  /* Allows items to grow and fill available space */
        flex-shrink: 1;/* Allows items to shrink if needed */
        
        /* 
         * This is the most important part for stability.
         * It sets a minimum width. No matter how much you zoom,
         * the filter will never become smaller than this width.
         * If it can't fit, it will wrap to the next line.
        */
        min-width: 200px; 
    }

    /* 3. Remove default Bootstrap row padding that can interfere */
    .filter-container .form-group {
        margin-bottom: 0; /* The 'gap' property now handles all spacing */
    }
    
    /* --- END: Flexbox Fix --- */


    /* Optional: Styling for Select2 to ensure it fits perfectly */
    .select2-container--bootstrap4 .select2-selection--single {
        height: calc(1.5em + .75rem + 2px) !important;
    }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
        line-height: calc(1.5em + .75rem);
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="title">Customer List</h5>
                    <p class="category">Filter and search for customers</p>
                </div>
                <div class="card-body">
                    
                    <!-- START: Responsive Filters with Flexbox -->
                    <div class="filter-container">
                        <!-- Each filter is now a 'filter-item' inside the flex container -->
                        <div class="filter-item">
                            <div class="form-group">
                                <label>Country</label>
                                <select id="filter-country" class="form-control select2-dropdown">
                                    <option value="">All</option>
                                    {% for country in countries %}
                                        <option value="{{ country.id }}">{{ country.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="filter-item">
                            <div class="form-group">
                                <label>University</label>
                               <select id="filter-university" class="form-control select2-dropdown">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-item">
                            <div class="form-group">
                                <label>College</label>
                                <select id="filter-college" class="form-control select2-dropdown">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-item">
                            <div class="form-group">
                                <label>Search by Name</label>
                                <input type="text" id="search-name" class="form-control" placeholder="Filter by name...">
                            </div>
                        </div>
                        <div class="filter-item">
                            <div class="form-group">
                                <label>Search by Email</label>
                                <input type="text" id="search-email" class="form-control" placeholder="Filter by email...">
                            </div>
                        </div>
                        <div class="filter-item">
                            <div class="form-group">
                                <label>Search by Phone</label>
                                <input type="text" id="search-phone" class="form-control" placeholder="Filter by phone...">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!-- END: Filters and Search Bars -->

                    <div class="table-responsive">
                        <table class="table tablesorter" id="customer-table">
                            <thead class="text-primary">
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>WhatsApp</th>
                                    <th>Year</th>
                                    <th>College</th>
                                    <th>University</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in customers %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('main.customer_profile', customer_id=customer.id) }}">
                                            {{ customer.full_name }}
                                        </a>
                                    </td>
                                    <td>{{ customer.email or 'N/A' }}</td>
                                    <td>{{ customer.whatsapp_number or 'N/A' }}</td>
                                    <td>{{ customer.year or 'N/A' }}</td>
                                    <td>{{ customer.college.name }}</td>
                                    <td>{{ customer.college.university.name }}</td>
                                   <td class="text-center">
                                    <a href="{{ url_for('main.edit_customer', customer_id=customer.id) }}" class="btn btn-sm btn-success">Edit</a>
                                    <form action="{{ url_for('main.delete_customer', customer_id=customer.id) }}" method="POST" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">                                        
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this customer?');">Delete</button>
                                    </form>
                                  </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Chatbot HTML -->
<div id="chatbot-container" class="chatbot-hidden">
    <img src="{{ url_for('static', filename='assets/img/chat.jpg') }}" alt="عبدالمطلب" class="chatbot-avatar">
    <div class="chatbot-message">
        <strong class="chatbot-name">عبدالمطلب</strong>
        <p id="chatbot-text"></p>
    </div>
</div>

{% endblock content %}


{% block javascripts %}
{{ super() }} {# This includes the default scripts from the template #}

<script>
// Use jQuery's document ready function for better compatibility with Select2
$(document).ready(function() {
    // Initialize Select2 on all dropdowns with this class
    $('.select2-dropdown').select2({
        theme: "bootstrap4"
    });

    // --- Element Selectors ---
    const countryFilter = document.getElementById('filter-country');
    const universityFilter = document.getElementById('filter-university');
    const collegeFilter = document.getElementById('filter-college');
    const nameSearch = document.getElementById('search-name');
    const emailSearch = document.getElementById('search-email');
    const phoneSearch = document.getElementById('search-phone');
    const customerTableBody = document.querySelector('#customer-table tbody');

    function updateSelect(selectElement, options, placeholder) {
        const $select = $(selectElement); // Get the jQuery version of the element
        $select.empty(); // Use jQuery's empty() method
        
        // Add the placeholder
        $select.append(new Option(placeholder, ''));

        // Add the new options
        options.forEach(option => {
            $select.append(new Option(option.name, option.id));
        });

        // Trigger the change event for Select2 to re-render
        $select.trigger('change');
    }

    // --- Logic for Flash Messages via Chatbot ---
    function showChatbotMessage(text, type = 'success') {
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotText = document.getElementById('chatbot-text');

        chatbotContainer.classList.remove('chatbot-success', 'chatbot-danger');
        
        if (type === 'success') {
            chatbotContainer.classList.add('chatbot-success');
        } else if (type === 'danger') {
            chatbotContainer.classList.add('chatbot-danger');
        }

        chatbotText.textContent = text;
        chatbotContainer.classList.remove('chatbot-hidden');
        chatbotContainer.classList.add('chatbot-visible');

        setTimeout(() => {
            chatbotContainer.classList.remove('chatbot-visible');
            chatbotContainer.classList.add('chatbot-hidden');
        }, 5000);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const message = urlParams.get('message');
    const messageType = urlParams.get('type');

    if (message) {
        showChatbotMessage(message, messageType);
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // --- Main function to fetch and render customers ---
    function fetchAndRenderCustomers() {
        const params = new URLSearchParams({
            country_id: countryFilter.value,
            university_id: universityFilter.value,
            college_id: collegeFilter.value,
            name: nameSearch.value,
            email: emailSearch.value,
            phone: phoneSearch.value
        });

        fetch(`/api/filter_customers?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                customerTableBody.innerHTML = ''; // Clear the table
                if (data.customers.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center">No customers found.</td>`;
                    customerTableBody.appendChild(row);
                } else {
                    data.customers.forEach(customer => {
                        const row = document.createElement('tr');
                        // IMPORTANT: Use url_for inside the template, not in JS.
                        // We construct the URLs manually here.
                        const editUrl = `/edit_customer/${customer.id}`;
                        const deleteUrl = `/delete_customer/${customer.id}`;
                        const csrfToken = '{{ csrf_token() }}'; // Get CSRF token from template

                        row.innerHTML = `
                            <td><a href="/customer_profile/${customer.id}">${customer.full_name}</a></td>
                            <td>${customer.email || 'N/A'}</td>
                            <td>${customer.whatsapp_number || 'N/A'}</td>
                            <td>${customer.year || 'N/A'}</td>
                            <td>${customer.college_name}</td>
                            <td>${customer.university_name}</td>
                            <td class="text-center">
                                <a href="${editUrl}" class="btn btn-sm btn-success">Edit</a>
                                <form action="${deleteUrl}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this customer?');">
                                    <input type="hidden" name="csrf_token" value="${csrfToken}">        
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        `;
                        customerTableBody.appendChild(row);
                    });
                }
            });
    }

    // --- Event Listeners for Dynamic Dropdowns (jQuery version for Select2) ---
    $('#filter-country').on('change', function() {
        const countryId = $(this).val();
        if (countryId) {
            fetch(`/api_get_universities/${countryId}`)
                .then(response => response.json())
                .then(data => {
                    updateSelect(universityFilter, data.universities, 'All');
                    updateSelect(collegeFilter, [], 'All');
                });
        } else {
            updateSelect(universityFilter, [], 'All');
            updateSelect(collegeFilter, [], 'All');
        }
        fetchAndRenderCustomers();
    });

    $('#filter-university').on('change', function() {
        const universityId = $(this).val();
        if (universityId) {
           fetch(`/api_get_colleges/${universityId}`)
                .then(response => response.json())
                .then(data => updateSelect(collegeFilter, data.colleges, 'All'));
        } else {
            updateSelect(collegeFilter, [], 'All');
        }
        fetchAndRenderCustomers();
    });

    // --- Event Listeners for all filters (Select2 Compatible) ---
    $('#filter-college').on('change', fetchAndRenderCustomers);
    
    $('#search-name').on('keyup', fetchAndRenderCustomers);
    $('#search-email').on('keyup', fetchAndRenderCustomers);
    $('#search-phone').on('keyup', fetchAndRenderCustomers);
});
</script>

{% endblock javascripts %}